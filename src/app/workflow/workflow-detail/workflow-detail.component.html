<h1 class="wipp-title">
  {{workflow.name}}
  <div style="display: inline-block;">
    <p-button icon="pi pi-copy"
              (click)="copyWorkflow()"
              pTooltip="Copy workflow"
              tooltipPosition="left"
              [outlined]="true">
    </p-button>
    <p-button icon="pi pi-globe" *ngIf="!workflow.publiclyShared && canEdit()" type="button"
              pTooltip="Make workflow public"
              tooltipPosition="left"
              [outlined]="true"
              (click)="makeWorkflowPublic();">
    </p-button>
  </div>
</h1>

<p-fieldset legend="Details" [toggleable]="true">
  <div class="grid nested-grid">
    <div class="col-12 md:col-6">
      <div class="grid">
        <div class="col-3 py-1 font-semibold">
          Name:
        </div>
        <div class="col-9 py-1">
          {{workflow.name}}
        </div>
        <div class="col-3 py-1 font-semibold">
          Creation date:
        </div>
        <div class="col-9 py-1">
          {{workflow.creationDate | date}}
        </div>
        <div class="col-3 py-1 font-semibold">
          Owner:
        </div>
        <div class="col-9 py-1">
          {{workflow.owner}}
        </div>
        <div class="col-3 py-1 font-semibold">
          Status:
        </div>
        <div class="col-9 py-1">
          {{workflow.status}}
          <span *ngIf="workflow.status === 'ERROR' && workflow.errorMessage"
                pTooltip={{workflow.errorMessage}}
                tooltipPosition="right"
                aria-hidden="true"><i class="pi pi-question-circle"></i>
        </span>
        </div>
        <div class="col-3 py-1 font-semibold">
          Visibility:
        </div>
        <div class="col-9 py-1">
          <div *ngIf="workflow.publiclyShared; else privateData">Public</div>
          <ng-template #privateData>Private</ng-template>
        </div>
      </div>
    </div>
    <div class="col-12 md:col-6">
      <div class="block p-1 flex justify-content-left">
        <button pButton icon="pi pi-arrow-circle-right" *ngIf="workflow.status === 'CREATED'"
                class="p-button"
                label="Submit workflow"
                [disabled]="jobs.length < 1" (click)="submitWorkflow()">
        </button>
        <a class="p-button" *ngIf="workflow.generatedName" style="text-decoration: none;"
           href={{argoUiLink}}
           target="_blank"
           [pTooltip]="argoUiTipContent">
          Monitor execution
        </a>
      </div>

    </div>
  </div>
</p-fieldset>

<ngx-spinner></ngx-spinner>

<p-fieldset legend="Workflow tasks" [toggleable]="true">
<p-toolbar>
  <div class="p-toolbar-group-start">
    <button pButton icon="pi pi-plus-circle"
            label="Add task"
            (click)="open()"
            [disabled]="! workflow.name || workflow.status!='CREATED' || ! selectedSchema">
    </button>
  </div>
  <div class="p-toolbar-group-center">
    <label class="mb-0">Graph Orientation</label>
    <p-dropdown class="pl-2"
      [options]="orientationOptions"
      [(ngModel)]="layoutSettings.orientation"
      (onChange)="updateGraph();"
      optionLabel="label"
      optionValue="value"
      placeholder="Orientation" />
  </div>
  <div class="p-toolbar-group-end">
    <input type="checkbox" class="p-checkbox" [(ngModel)]="enableZoom">
    <label class="pl-2 mb-0">Enable zoom</label>
  </div>
</p-toolbar>
<div class="card pt-2">
  <div class="flex wf-dag" >
    <ngx-graph
      *ngIf="jobs.length > 0"
      class="chart-container"
      [ngStyle]="{'pointer-events':enableZoom === true ? 'all' : 'none' }"
      [links]=links
      [nodes]=nodes
      [update$]="update$"

      [layoutSettings]="layoutSettings"
      [enableZoom]="enableZoom"
      [draggingEnabled]="false"
      [panningEnabled]="enableZoom"
      [autoCenter]="!enableZoom"
      [autoZoom]="!enableZoom"
      [panOnZoom]="true"
      [animate]="true"
    >
      <ng-template #nodeTemplate let-node>
        <svg:g class="node" (click)="displayJobModal(node.id)">
          <svg:rect
            [attr.width]="node.dimension.width"
            [attr.height]="node.dimension.height"
            [attr.fill]="node.data.color"
          />
          <svg:text alignment-baseline="central" [attr.x]="10" [attr.y]="node.dimension.height / 2">
            {{node.label}}
          </svg:text>
        </svg:g >

        <svg:g class="node" *ngIf="workflow.status === 'CREATED'" (click)="openCopy(node.id)" >
          <svg:rect
            [attr.x]="node.dimension.width + 18"
            [attr.width]="20"
            [attr.height]="node.dimension.height"
            [attr.fill]="node.data.color"
          />
          <svg [attr.x]="node.dimension.width + 20" [attr.y]="node.dimension.height / 2 - 6" width="14" height="13" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
            <path d="M1696 384q40 0 68 28t28 68v1216q0 40-28 68t-68 28h-960q-40 0-68-28t-28-68v-288h-544q-40 0-68-28t-28-68v-672q0-40 20-88t48-76l408-408q28-28 76-48t88-20h416q40 0 68 28t28 68v328q68-40 128-40h416zm-544 213l-299 299h299v-299zm-640-384l-299 299h299v-299zm196 647l316-316v-416h-384v416q0 40-28 68t-68 28h-416v640h512v-256q0-40 20-88t48-76zm956 804v-1152h-384v416q0 40-28 68t-68 28h-416v640h896z"/>
          </svg>
        </svg:g>
        <svg:g class="node" *ngIf="workflow.status === 'CREATED'" (click)="openEdit(node.id)">
          <svg:rect
            [attr.x]="node.dimension.width -1 "
            [attr.width]="20"
            [attr.height]="node.dimension.height"
            [attr.fill]="node.data.color"
          />
          <svg [attr.x]="node.dimension.width " [attr.y]="node.dimension.height / 2 - 6" width="14" height="14" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
            <path d="M888 1184l116-116-152-152-116 116v56h96v96h56zm440-720q-16-16-33 1l-350 350q-17 17-1 33t33-1l350-350q17-17 1-33zm80 594v190q0 119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119 84.5-203.5t203.5-84.5h832q63 0 117 25 15 7 18 23 3 17-9 29l-49 49q-14 14-32 8-23-6-45-6h-832q-66 0-113 47t-47 113v832q0 66 47 113t113 47h832q66 0 113-47t47-113v-126q0-13 9-22l64-64q15-15 35-7t20 29zm-96-738l288 288-672 672h-288v-288zm444 132l-92 92-288-288 92-92q28-28 68-28t68 28l152 152q28 28 28 68t-28 68z"/>
          </svg>
        </svg:g>

        <svg:g class="node" *ngIf="workflow.status === 'CREATED'" (click)="deleteJob(node.id)">
          <svg:rect
            [attr.x]="node.dimension.width + 37 "
            [attr.width]="20"
            [attr.height]="node.dimension.height"
            [attr.fill]="node.data.color"
          />

          <svg [attr.x]="node.dimension.width + 40 " [attr.y]="node.dimension.height / 2 - 6" width="14" height="14" viewBox="0 0 1792 1792" xmlns="http://www.w3.org/2000/svg">
            <path d="M1490 1322q0 40-28 68l-136 136q-28 28-68 28t-68-28l-294-294-294 294q-28 28-68 28t-68-28l-136-136q-28-28-28-68t28-68l294-294-294-294q-28-28-28-68t28-68l136-136q28-28 68-28t68 28l294 294 294-294q28-28 68-28t68 28l136 136q28 28 28 68t-28 68l-294 294 294 294q28 28 28 68z"/>
          </svg>
        </svg:g>
      </ng-template>
    </ngx-graph>
  </div>
</div>
</p-fieldset>

<p-dialog header="New Task" [modal]="true" [(visible)]="newTaskDialogVisible" *ngIf="newTaskDialogVisible" [style]="{ width: '50rem' }">
  <div class="field">
    <label for="pluginName" class="font-semibold">Select Computational Plugin</label>
    <p-dropdown class="p-2"
      id="pluginName"
      [disabled]="editMode"
      [options]="pluginList"
      [(ngModel)]="selectedSchema"
      optionLabel="name"
      [filter]="true"
      filterBy="name"
      [showClear]="true"
      placeholder="Select a plugin">
      <ng-template pTemplate="selectedItem" let-selectedOption>
        <div class="flex align-items-center gap-2">
          <div>{{ selectedOption.name }} {{ selectedOption.version }}</div>
        </div>
      </ng-template>
      <ng-template let-plugin pTemplate="item">
        <div class="flex align-items-center gap-2">
          <div>{{ plugin.name }} {{ plugin.version }}</div>
        </div>
      </ng-template>
    </p-dropdown>
  </div>
  <p-divider />
  <div class="form pt-2">
    <sf-form [hidden]="!selectedSchema?.isSchemaValid"
             [schema]="selectedSchema" [bindings]="selectedSchema.fieldBindings" [model]="jobModel" #jsonForm>
    </sf-form>
    <p-messages severity="error" [hidden]="selectedSchema.isSchemaValid">
      <ng-template pTemplate>
        <div>
          Unable to generate form for {{ selectedSchema.name }} {{ selectedSchema.version }}, plugin manifest is invalid.
        </div>
      </ng-template>
    </p-messages>
  </div>
  <div class="flex justify-content-end gap-2 pt-2">
    <p-button label="Cancel" severity="secondary" (onClick)="newTaskDialogVisible = false; resetForm();" />
    <p-button [label]="editMode ? 'Edit task' : 'Add task'"
              (click)="newTaskDialogVisible = false; saveTask(jsonForm.rootProperty.value)" />
  </div>
</p-dialog>

<ng-template #argoUiTipContent> See in Argo dashboard
  <span aria-hidden="true"><i class="pi pi-external-link"></i></span>
</ng-template>

<p-toast position="top-center"/>
